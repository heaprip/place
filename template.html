<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HTTP Streaming PNG Overlay</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; image-rendering: pixelated; cursor: crosshair; }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false });

const SCALE = 4;
const WIDTH = 100;
const HEIGHT = 100;

canvas.width = WIDTH * SCALE;
canvas.height = HEIGHT * SCALE;
ctx.imageSmoothingEnabled = false;

const off = document.createElement('canvas');
off.width = WIDTH;
off.height = HEIGHT;
const offCtx = off.getContext('2d', { alpha: false });

async function startStream() {
  const res = await fetch('/stream');
  if (!res.body) throw new Error('Streaming not supported');

  const reader = res.body.getReader();
  let buffer = new Uint8Array(0);

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    const blob = new Blob([value], { type: 'image/png' });
    const img = await createImageBitmap(blob);
    offCtx.drawImage(img, 0, 0, WIDTH, HEIGHT);
    redraw(activePixel);
  }
}

function redraw(highlightPixel = null) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(off, 0, 0, canvas.width, canvas.height);

  if (highlightPixel) {
    ctx.strokeStyle = 'rgba(255,0,0,0.9)';
    ctx.lineWidth = 1;
    ctx.strokeRect(highlightPixel.x * SCALE, highlightPixel.y * SCALE, SCALE, SCALE);
  }
}

let activePixel = null;

canvas.addEventListener('mousemove', e => {
  const r = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - r.left) / SCALE);
  const y = Math.floor((e.clientY - r.top) / SCALE);
  if (x < 0 || y < 0 || x >= WIDTH || y >= HEIGHT) return;
  activePixel = { x, y };
  redraw(activePixel);
});

canvas.addEventListener('mouseleave', () => {
  activePixel = null;
  redraw();
});

canvas.addEventListener('click', () => {
  if (!activePixel) return;
  const { x, y } = activePixel;
  const p = offCtx.getImageData(x, y, 1, 1).data;
  onPixelClick({ x, y, r: p[0], g: p[1], b: p[2], a: p[3] });
});

function onPixelClick(info) {
  alert(JSON.stringify(info))
}

redraw();
startStream();
</script>
</body>
</html>
